Sub AggiornaCodiceVBA()
    Dim Http As Object
    Dim Stream As Object
    Dim vbProj As Object
    Dim vbComp As Object
    Dim ModuloNome As String
    Dim PercorsoFile As String
    Dim URL As String
    Dim NuovoCodice As String
    Dim Riga As String
    
    ' Configura il modulo da aggiornare
    ModuloNome = "Module1" ' Nome del modulo VBA
    PercorsoFile = ThisWorkbook.Path & "\aggiornamento.txt" ' Percorso temporaneo
    
    ' URL del file su GitHub con autenticazione tramite token
    URL = "https://raw.githubusercontent.com/jaupi-enrico/Excel_macros/main/aggiornamento.txt"
    
    ' Scarica il file
    Set Http = CreateObject("MSXML2.XMLHTTP")
    Http.Open "GET", URL, False
    Http.setRequestHeader "Authorization", "token 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"
    Http.Send
    
    If Http.Status = 200 Then
        ' Salva il file scaricato
        Set Stream = CreateObject("ADODB.Stream")
        Stream.Type = 2
        Stream.Charset = "utf-8"
        Stream.Open
        Stream.WriteText Http.responseText
        Stream.SaveToFile PercorsoFile, 2
        Stream.Close
        
        ' Leggi il nuovo codice dal file salvato
        Open PercorsoFile For Input As #1
        NuovoCodice = ""
        Do Until EOF(1)
            Line Input #1, Riga
            NuovoCodice = NuovoCodice & Riga & vbCrLf
        Loop
        Close #1
        
        ' Rimuove il BOM UTF-8
        NuovoCodice = RimuoviBOM(NuovoCodice)

        
        ' Modifica direttamente il codice del modulo
        Set vbProj = ThisWorkbook.VBProject
        Set vbComp = vbProj.VBComponents(ModuloNome).CodeModule
        
        ' Cancella tutto il codice esistente e scrive il nuovo codice
        vbComp.DeleteLines 1, vbComp.CountOfLines
        vbComp.AddFromString NuovoCodice
        
        MsgBox "Codice aggiornato con successo!", vbInformation
    Else
        MsgBox "Errore nel download del codice! Stato: " & Http.Status, vbCritical
    End If
End Sub

Function RimuoviBOM(Testo As String) As String
    If Left(Testo, 3) = ChrW(&HFEFF) Then
        RimuoviBOM = Mid(Testo, 4) ' Rimuove il BOM UTF-8
    Else
        RimuoviBOM = Testo
    End If
End Function